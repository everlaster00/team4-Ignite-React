// npx prisma migrate dev --schema=./prisma/Main.prisma --name message
// npx prisma migrate reset --schema=./prisma/Main.prisma
// npx prisma generate --schema=./prisma/Main.prisma
generator Main_client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client/main"
}

datasource Main_db {
  provider  = "postgresql"
  url       = env("MAIN_DATABASE_URL")
  directUrl = env("MAIN_DIRECT_URL")
}

// 아래 데이터 베이스의 내용이 수정 될 때마다
// npx prisma migrate dev --name 작업내역메시지
// 배포된 환경에서는 npx prisma migrate deploy

//# 마지막 마이그레이션 되돌리기. 롤백용 (개발 환경) (경고: 모든 데이터 손실))
// npx prisma migrate reset

// 데이터베이스 작성 예제
enum Role {
  USER
  ADMIN
}

model Connection {
  id             String           @id @default(uuid())
  ipAddress      String
  updateAt       DateTime         @updatedAt
  postLikes      PostLike[]
  commentLikes   CommentLike[]
}

model User {
  id           String    @id @default(cuid()) //uuid보다 가볍지만 보안성은 좀 더 떨어짐
  email        String    
  password     String    
  name         String    @unique @Main_db.VarChar(20) //닉네임 (실명정보 무쓸모)
  roll         Role      @default(USER) //권한
  createdAt    DateTime  @default(now()) //최초 가입일
  lastLoggedIn DateTime? //마지막 접속일(수동 관리)
  posts        Post[]
  comments     Comment[]
  postLikes    PostLike[]
  commentLikes CommentLike[]

  // name은 검색 빈도에 따라 결정
  // @@index([name])  // 자주 검색하면 추가
}

model Post {
  id        Int       @id @default(autoincrement())
  title     String
  content   String
  authorId  String?
  author    User?      @relation(fields: [authorId], references: [id])
  anonym    String    @default("이그나이터") @Main_db.VarChar(20)
  anonyPass String?
  status    String // 'DRAFT', 'PUBLISHED'
  createdAt DateTime  @default(now())
  updateAt  DateTime  @updatedAt
  comments  Comment[]
  likes     PostLike[]

  // 복합 인덱스: 동시에 자주 사용
  @@index([authorId, status])
  // 단일 인덱스: 정렬용
  @@index([createdAt(sort: Desc)])

}

model Comment {
  id        Int        @id @default(autoincrement())
  postId    Int
  post      Post       @relation(fields: [postId], references: [id])
  userId    String?
  user      User?      @relation(fields: [userId], references: [id])
  anonym    String     @default("이그나이터") @Main_db.VarChar(20)
  anonyPass String?
  content   String
  createdAt DateTime   @default(now())
  updateAt  DateTime   @updatedAt
  likes     CommentLike[]

  @@index([postId]) // 게시글의 댓글 조회
  @@index([userId]) // 사용자의 댓글 조회
}

model PostLike {
  id        BigInt       @id @default(autoincrement())

  userId    String?
  user      User?        @relation(fields: [userId], references: [id])

  anonymId  String?
  anonym    Connection?  @relation(fields: [anonymId],references: [id])

  postId    Int
  post      Post         @relation(fields: [postId], references: [id])

  @@unique([postId, userId])
  @@unique([postId, anonymId])
}

model CommentLike {
  id        BigInt       @id @default(autoincrement())

  userId    String?
  user      User?        @relation(fields: [userId], references: [id])

  anonymId  String?
  anonym    Connection?  @relation(fields: [anonymId],references: [id])

  commentId Int
  comment   Comment      @relation(fields: [commentId], references: [id])

  @@unique([commentId, userId])
  @@unique([commentId,anonymId])
}
